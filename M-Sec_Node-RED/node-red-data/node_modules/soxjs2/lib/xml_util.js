"use strict";

var _device = require("./device");

var _device2 = _interopRequireDefault(_device);

var _device_meta = require("./device_meta");

var _device_meta2 = _interopRequireDefault(_device_meta);

var _meta_transducer = require("./meta_transducer");

var _meta_transducer2 = _interopRequireDefault(_meta_transducer);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var _xmlDeclarePatStr = "^<\\?xml[^>]+?>";
var _xmlDeclarePat = new RegExp(_xmlDeclarePatStr);

var XmlUtil = {

  removeXmlDeclaration: function removeXmlDeclaration(xmlString) {
    return xmlString.replace(_xmlDeclarePat, "");
  },

  dumpDom: function dumpDom(dom, indent) {
    if (indent === undefined) {
      indent = 0;
    }
    var tagName = dom._localName;
    var children = dom._childNodesList;
    var attrs = dom._attributes;

    var sp = "";
    for (var i = 0; i < indent; i++) {
      sp = sp + "  ";
    }

    var log = function log(msg) {
      //console.log(sp + msg);
    };

    log("---tag: " + tagName);
    // log("---attributes:");
    // for (let aName of Object.keys(attrs)) {
    //   let av = attrs[aName]._valueForAttrModified;
    //   log("  - " + aName + ": " + av);
    // }
    if (children && 0 < children.length) {
      log("---children:");
      for (var i = 0; i < children.length; i++) {
        var c = children[i];
        XmlUtil.dumpDom(c, indent + 1);
      }
    }
  },

  convRecentItem: function convRecentItem(soxConnection, iq) {
    XmlUtil.dumpDom(iq);
    var fromService = iq._attributes['from']._valueForAttrModified;
    var fromDomain = fromService.substring(7);

    var pubsubTag = iq._childNodesList[0];
    var itemsTag = pubsubTag._childNodesList[0];
    var itemTag = itemsTag._childNodesList[0];
    var deviceTag = itemTag._childNodesList[0];
    var transducerTags = deviceTag._childNodesList;

    var getAttr = function getAttr(attrs, name) {
      var v = attrs[name];
      return v ? v._valueForAttrModified : v;
    };

    // device: name, id, type, serialNumber
    var deviceTagAttr = deviceTag._attributes;
    var deviceName = getAttr(deviceTagAttr, 'name');
    var deviceId = getAttr(deviceTagAttr, 'id');
    var deviceType = getAttr(deviceTagAttr, 'type');
    var deviceSerialNumber = getAttr(deviceTagAttr, 'serialNumber');

    // transducer: name, id, canActuate, hasOwnNode, units,
    //             unitScalar, minValue, maxValue, resolution
    var device = new _device2.default(soxConnection, deviceName, fromDomain);
    var transducers = [];

    for (var i = 0; i < transducerTags.length; i++) {
      var tdrTag = transducerTags[i];
      if (tdrTag._localName !== 'transducer') {
        continue;
      }
      var tdrAttrs = tdrTag._attributes;

      transducers.push(new _meta_transducer2.default(device, getAttr(tdrAttrs, 'name'), getAttr(tdrAttrs, 'id'), getAttr(tdrAttrs, 'canActuate'), getAttr(tdrAttrs, 'hasOwnNode'), getAttr(tdrAttrs, 'units'), getAttr(tdrAttrs, 'unitScalar'), getAttr(tdrAttrs, 'minValue'), getAttr(tdrAttrs, 'maxValue'), getAttr(tdrAttrs, 'resolution')));
    }

    var meta = new _device_meta2.default(device, deviceId, deviceType, deviceSerialNumber, transducers);
    return meta;
  },

  convSubscriptions: function convSubscriptions(iq) {
    var pubsubTag = iq._childNodesList[0];
    var subscriptionsTag = pubsubTag._childNodesList[0];
    var subscriptionTags = subscriptionsTag._childNodesList;

    var ret = {};
    for (var i = 0; i < subscriptionTags.length; i++) {
      var subscriptionTag = subscriptionTags[i];

      var attrs = subscriptionTag._attributes;

      var jid = attrs.jid._valueForAttrModified;
      if (ret[jid] === undefined) {
        ret[jid] = {};
      }

      var nodeName = attrs.node._valueForAttrModified;
      var subidAttr = attrs.subid;
      if (subidAttr !== undefined) {
        var subid = subidAttr._valueForAttrModified;
        if (ret[jid][nodeName] === undefined) {
          ret[jid][nodeName] = [];
        }
        ret[jid][nodeName].push(subid);
      } else {
        ret[jid][nodeName] = [];
      }
    }

    return ret;
  }

};

module.exports = XmlUtil;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy94bWxfdXRpbC5qcyJdLCJuYW1lcyI6WyJfeG1sRGVjbGFyZVBhdFN0ciIsIl94bWxEZWNsYXJlUGF0IiwiUmVnRXhwIiwiWG1sVXRpbCIsInJlbW92ZVhtbERlY2xhcmF0aW9uIiwieG1sU3RyaW5nIiwicmVwbGFjZSIsImR1bXBEb20iLCJkb20iLCJpbmRlbnQiLCJ1bmRlZmluZWQiLCJ0YWdOYW1lIiwiX2xvY2FsTmFtZSIsImNoaWxkcmVuIiwiX2NoaWxkTm9kZXNMaXN0IiwiYXR0cnMiLCJfYXR0cmlidXRlcyIsInNwIiwiaSIsImxvZyIsIm1zZyIsImxlbmd0aCIsImMiLCJjb252UmVjZW50SXRlbSIsInNveENvbm5lY3Rpb24iLCJpcSIsImZyb21TZXJ2aWNlIiwiX3ZhbHVlRm9yQXR0ck1vZGlmaWVkIiwiZnJvbURvbWFpbiIsInN1YnN0cmluZyIsInB1YnN1YlRhZyIsIml0ZW1zVGFnIiwiaXRlbVRhZyIsImRldmljZVRhZyIsInRyYW5zZHVjZXJUYWdzIiwiZ2V0QXR0ciIsIm5hbWUiLCJ2IiwiZGV2aWNlVGFnQXR0ciIsImRldmljZU5hbWUiLCJkZXZpY2VJZCIsImRldmljZVR5cGUiLCJkZXZpY2VTZXJpYWxOdW1iZXIiLCJkZXZpY2UiLCJEZXZpY2UiLCJ0cmFuc2R1Y2VycyIsInRkclRhZyIsInRkckF0dHJzIiwicHVzaCIsIk1ldGFUcmFuc2R1Y2VyIiwibWV0YSIsIkRldmljZU1ldGEiLCJjb252U3Vic2NyaXB0aW9ucyIsInN1YnNjcmlwdGlvbnNUYWciLCJzdWJzY3JpcHRpb25UYWdzIiwicmV0Iiwic3Vic2NyaXB0aW9uVGFnIiwiamlkIiwibm9kZU5hbWUiLCJub2RlIiwic3ViaWRBdHRyIiwic3ViaWQiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUVBOzs7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FBRUEsSUFBSUEsb0JBQW9CLGlCQUF4QjtBQUNBLElBQUlDLGlCQUFpQixJQUFJQyxNQUFKLENBQVdG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cEI7QUFDQSxVQUFJNEIsSUFBSUUsR0FBSixNQUFhL0MsU0FBakIsRUFBNEI7QUFDMUI2QyxZQUFJRSxHQUFKLElBQVcsRUFBWDtBQUNEOztBQUVELFVBQUlDLFdBQVczQyxNQUFNNEMsSUFBTixDQUFXaEMscUJBQTFCO0FBQ0EsVUFBSWlDLFlBQVk3QyxNQUFNOEMsS0FBdEI7QUFDQSxVQUFJRCxjQUFjbEQsU0FBbEIsRUFBNkI7QUFDM0IsWUFBSW1ELFFBQVFELFVBQVVqQyxxQkFBdEI7QUFDQSxZQUFJNEIsSUFBSUUsR0FBSixFQUFTQyxRQUFULE1BQXVCaEQsU0FBM0IsRUFBc0M7QUFDcEM2QyxjQUFJRSxHQUFKLEVBQVNDLFFBQVQsSUFBcUIsRUFBckI7QUFDRDtBQUNESCxZQUFJRSxHQUFKLEVBQVNDLFFBQVQsRUFBbUJWLElBQW5CLENBQXdCYSxLQUF4QjtBQUNELE9BTkQsTUFNTztBQUNMTixZQUFJRSxHQUFKLEVBQVNDLFFBQVQsSUFBcUIsRUFBckI7QUFDRDtBQUNGOztBQUVELFdBQU9ILEdBQVA7QUFDRDs7QUExSGEsQ0FBaEI7O0FBOEhBTyxPQUFPQyxPQUFQLEdBQWlCNUQsT0FBakIiLCJmaWxlIjoieG1sX3V0aWwuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcblxuaW1wb3J0IERldmljZSBmcm9tIFwiLi9kZXZpY2VcIjtcbmltcG9ydCBEZXZpY2VNZXRhIGZyb20gXCIuL2RldmljZV9tZXRhXCI7XG5pbXBvcnQgTWV0YVRyYW5zZHVjZXIgZnJvbSBcIi4vbWV0YV90cmFuc2R1Y2VyXCI7XG5cbnZhciBfeG1sRGVjbGFyZVBhdFN0ciA9IFwiXjxcXFxcP3htbFtePl0rPz5cIjtcbnZhciBfeG1sRGVjbGFyZVBhdCA9IG5ldyBSZWdFeHAoX3htbERlY2xhcmVQYXRTdHIpO1xuXG5cbmNvbnN0IFhtbFV0aWwgPSB7XG5cbiAgcmVtb3ZlWG1sRGVjbGFyYXRpb246ICh4bWxTdHJpbmcpID0+IHtcbiAgICByZXR1cm4geG1sU3RyaW5nLnJlcGxhY2UoX3htbERlY2xhcmVQYXQsIFwiXCIpO1xuICB9LFxuXG4gIGR1bXBEb206IChkb20sIGluZGVudCkgPT4ge1xuICAgIGlmIChpbmRlbnQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgaW5kZW50ID0gMDtcbiAgICB9XG4gICAgbGV0IHRhZ05hbWUgPSBkb20uX2xvY2FsTmFtZTtcbiAgICBsZXQgY2hpbGRyZW4gPSBkb20uX2NoaWxkTm9kZXNMaXN0O1xuICAgIGxldCBhdHRycyA9IGRvbS5fYXR0cmlidXRlcztcblxuICAgIHZhciBzcCA9IFwiXCI7XG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbmRlbnQ7IGkrKykge1xuICAgICAgc3AgPSBzcCArIFwiICBcIjtcbiAgICB9XG5cbiAgICBsZXQgbG9nID0gKG1zZykgPT4ge1xuICAgICAgLy9jb25zb2xlLmxvZyhzcCArIG1zZyk7XG4gICAgfTtcblxuICAgIGxvZyhcIi0tLXRhZzogXCIgKyB0YWdOYW1lKTtcbiAgICAvLyBsb2coXCItLS1hdHRyaWJ1dGVzOlwiKTtcbiAgICAvLyBmb3IgKGxldCBhTmFtZSBvZiBPYmplY3Qua2V5cyhhdHRycykpIHtcbiAgICAvLyAgIGxldCBhdiA9IGF0dHJzW2FOYW1lXS5fdmFsdWVGb3JBdHRyTW9kaWZpZWQ7XG4gICAgLy8gICBsb2coXCIgIC0gXCIgKyBhTmFtZSArIFwiOiBcIiArIGF2KTtcbiAgICAvLyB9XG4gICAgaWYgKGNoaWxkcmVuICYmIDAgPCBjaGlsZHJlbi5sZW5ndGgpIHtcbiAgICAgIGxvZyhcIi0tLWNoaWxkcmVuOlwiKTtcbiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgbGV0IGMgPSBjaGlsZHJlbltpXTtcbiAgICAgICAgWG1sVXRpbC5kdW1wRG9tKGMsIGluZGVudCArIDEpO1xuICAgICAgfVxuICAgIH1cbiAgfSxcblxuICBjb252UmVjZW50SXRlbTogKHNveENvbm5lY3Rpb24sIGlxKSA9PiB7XG4gICAgWG1sVXRpbC5kdW1wRG9tKGlxKTtcbiAgICBsZXQgZnJvbVNlcnZpY2UgPSBpcS5fYXR0cmlidXRlc1snZnJvbSddLl92YWx1ZUZvckF0dHJNb2RpZmllZDtcbiAgICBsZXQgZnJvbURvbWFpbiA9IGZyb21TZXJ2aWNlLnN1YnN0cmluZyg3KTtcblxuICAgIGxldCBwdWJzdWJUYWcgPSBpcS5fY2hpbGROb2Rlc0xpc3RbMF07XG4gICAgbGV0IGl0ZW1zVGFnID0gcHVic3ViVGFnLl9jaGlsZE5vZGVzTGlzdFswXTtcbiAgICBsZXQgaXRlbVRhZyA9IGl0ZW1zVGFnLl9jaGlsZE5vZGVzTGlzdFswXTtcbiAgICBsZXQgZGV2aWNlVGFnID0gaXRlbVRhZy5fY2hpbGROb2Rlc0xpc3RbMF07XG4gICAgbGV0IHRyYW5zZHVjZXJUYWdzID0gZGV2aWNlVGFnLl9jaGlsZE5vZGVzTGlzdDtcblxuICAgIGxldCBnZXRBdHRyID0gKGF0dHJzLCBuYW1lKSA9PiB7XG4gICAgICBsZXQgdiA9IGF0dHJzW25hbWVdO1xuICAgICAgcmV0dXJuICh2KSA/IHYuX3ZhbHVlRm9yQXR0ck1vZGlmaWVkIDogdjtcbiAgICB9O1xuXG4gICAgLy8gZGV2aWNlOiBuYW1lLCBpZCwgdHlwZSwgc2VyaWFsTnVtYmVyXG4gICAgbGV0IGRldmljZVRhZ0F0dHIgPSBkZXZpY2VUYWcuX2F0dHJpYnV0ZXM7XG4gICAgbGV0IGRldmljZU5hbWUgPSBnZXRBdHRyKGRldmljZVRhZ0F0dHIsICduYW1lJyk7XG4gICAgbGV0IGRldmljZUlkID0gZ2V0QXR0cihkZXZpY2VUYWdBdHRyLCAnaWQnKTtcbiAgICBsZXQgZGV2aWNlVHlwZSA9IGdldEF0dHIoZGV2aWNlVGFnQXR0ciwgJ3R5cGUnKTtcbiAgICBsZXQgZGV2aWNlU2VyaWFsTnVtYmVyID0gZ2V0QXR0cihkZXZpY2VUYWdBdHRyLCAnc2VyaWFsTnVtYmVyJyk7XG5cbiAgICAvLyB0cmFuc2R1Y2VyOiBuYW1lLCBpZCwgY2FuQWN0dWF0ZSwgaGFzT3duTm9kZSwgdW5pdHMsXG4gICAgLy8gICAgICAgICAgICAgdW5pdFNjYWxhciwgbWluVmFsdWUsIG1heFZhbHVlLCByZXNvbHV0aW9uXG4gICAgbGV0IGRldmljZSA9IG5ldyBEZXZpY2Uoc294Q29ubmVjdGlvbiwgZGV2aWNlTmFtZSwgZnJvbURvbWFpbik7XG4gICAgbGV0IHRyYW5zZHVjZXJzID0gW107XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRyYW5zZHVjZXJUYWdzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQgdGRyVGFnID0gdHJhbnNkdWNlclRhZ3NbaV07XG4gICAgICBpZiAodGRyVGFnLl9sb2NhbE5hbWUgIT09ICd0cmFuc2R1Y2VyJykge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGxldCB0ZHJBdHRycyA9IHRkclRhZy5fYXR0cmlidXRlcztcblxuICAgICAgdHJhbnNkdWNlcnMucHVzaChuZXcgTWV0YVRyYW5zZHVjZXIoXG4gICAgICAgIGRldmljZSxcbiAgICAgICAgZ2V0QXR0cih0ZHJBdHRycywgJ25hbWUnKSxcbiAgICAgICAgZ2V0QXR0cih0ZHJBdHRycywgJ2lkJyksXG4gICAgICAgIGdldEF0dHIodGRyQXR0cnMsICdjYW5BY3R1YXRlJyksXG4gICAgICAgIGdldEF0dHIodGRyQXR0cnMsICdoYXNPd25Ob2RlJyksXG4gICAgICAgIGdldEF0dHIodGRyQXR0cnMsICd1bml0cycpLFxuICAgICAgICBnZXRBdHRyKHRkckF0dHJzLCAndW5pdFNjYWxhcicpLFxuICAgICAgICBnZXRBdHRyKHRkckF0dHJzLCAnbWluVmFsdWUnKSxcbiAgICAgICAgZ2V0QXR0cih0ZHJBdHRycywgJ21heFZhbHVlJyksXG4gICAgICAgIGdldEF0dHIodGRyQXR0cnMsICdyZXNvbHV0aW9uJylcbiAgICAgICkpO1xuICAgIH1cblxuICAgIGxldCBtZXRhID0gbmV3IERldmljZU1ldGEoXG4gICAgICBkZXZpY2UsIGRldmljZUlkLCBkZXZpY2VUeXBlLCBkZXZpY2VTZXJpYWxOdW1iZXIsIHRyYW5zZHVjZXJzKTtcbiAgICByZXR1cm4gbWV0YTtcbiAgfSxcblxuICBjb252U3Vic2NyaXB0aW9uczogKGlxKSA9PiB7XG4gICAgbGV0IHB1YnN1YlRhZyA9IGlxLl9jaGlsZE5vZGVzTGlzdFswXTtcbiAgICBsZXQgc3Vic2NyaXB0aW9uc1RhZyA9IHB1YnN1YlRhZy5fY2hpbGROb2Rlc0xpc3RbMF07XG4gICAgbGV0IHN1YnNjcmlwdGlvblRhZ3MgPSBzdWJzY3JpcHRpb25zVGFnLl9jaGlsZE5vZGVzTGlzdDtcblxuICAgIGxldCByZXQgPSB7fTtcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN1YnNjcmlwdGlvblRhZ3MubGVuZ3RoOyBpKyspIHtcbiAgICAgIGxldCBzdWJzY3JpcHRpb25UYWcgPSBzdWJzY3JpcHRpb25UYWdzW2ldO1xuXG4gICAgICBsZXQgYXR0cnMgPSBzdWJzY3JpcHRpb25UYWcuX2F0dHJpYnV0ZXM7XG5cbiAgICAgIGxldCBqaWQgPSBhdHRycy5qaWQuX3ZhbHVlRm9yQXR0ck1vZGlmaWVkO1xuICAgICAgaWYgKHJldFtqaWRdID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0W2ppZF0gPSB7fTtcbiAgICAgIH1cblxuICAgICAgbGV0IG5vZGVOYW1lID0gYXR0cnMubm9kZS5fdmFsdWVGb3JBdHRyTW9kaWZpZWQ7XG4gICAgICBsZXQgc3ViaWRBdHRyID0gYXR0cnMuc3ViaWQ7XG4gICAgICBpZiAoc3ViaWRBdHRyICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgbGV0IHN1YmlkID0gc3ViaWRBdHRyLl92YWx1ZUZvckF0dHJNb2RpZmllZDtcbiAgICAgICAgaWYgKHJldFtqaWRdW25vZGVOYW1lXSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgcmV0W2ppZF1bbm9kZU5hbWVdID0gW107XG4gICAgICAgIH1cbiAgICAgICAgcmV0W2ppZF1bbm9kZU5hbWVdLnB1c2goc3ViaWQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0W2ppZF1bbm9kZU5hbWVdID0gW107XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHJldDtcbiAgfVxuXG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IFhtbFV0aWw7XG4iXX0=